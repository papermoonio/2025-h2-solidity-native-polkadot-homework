# Lesson 4 - DelegateCall ä»£ç†åˆçº¦å­¦ä¹ é¡¹ç›® ğŸš€

**å­¦å·**: 1921  
**ä½œè€…**: Student 1921  
**å®Œæˆæ—¥æœŸ**: 2025å¹´11æœˆ20æ—¥  

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ **delegatecall** ä»£ç†åˆçº¦ç³»ç»Ÿï¼Œæ·±å…¥å­¦ä¹ å’Œç†è§£äº†ä»£ç†åˆçº¦æ¨¡å¼çš„æ ¸å¿ƒæœºåˆ¶ã€‚é€šè¿‡å®ç°ç®€å•çš„è®¡æ•°å™¨é€»è¾‘ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ delegatecall æ¥æ‰§è¡Œé€»è¾‘åˆçº¦çš„å‡½æ•°ï¼ŒåŒæ—¶ç¡®ä¿è°ƒç”¨è€…çš„çŠ¶æ€è¢«ä¿ç•™ã€‚

### ğŸ¯ æ ¸å¿ƒå­¦ä¹ ç›®æ ‡
- âœ… ç†è§£ delegatecall ä¸æ™®é€š call çš„åŒºåˆ«
- âœ… æŒæ¡ä»£ç†åˆçº¦çš„å­˜å‚¨æ§½ä½åŒ¹é…æœºåˆ¶  
- âœ… å®ç°åˆçº¦é€»è¾‘çš„çƒ­æ›´æ–°èƒ½åŠ›
- âœ… éªŒè¯çŠ¶æ€æ•°æ®çš„æ­£ç¡®å­˜å‚¨ä½ç½®
- âœ… ç†è§£ msg.sender åœ¨ delegatecall ä¸­çš„ä¼ é€’

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
lesson-4/1921/
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ SimpleCounter.sol     # é€»è¾‘åˆçº¦ - å®šä¹‰ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ SimpleProxy.sol       # ä»£ç†åˆçº¦ - å®ç° delegatecall
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ simple-test.js        # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
â”‚   â””â”€â”€ DelegateCallTest.ts   # å®Œæ•´æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ deploy.ts             # TypeScriptéƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ simple-deploy.cjs     # CommonJSéƒ¨ç½²è„šæœ¬
â”œâ”€â”€ package.json              # é¡¹ç›®ä¾èµ–é…ç½®
â”œâ”€â”€ hardhat.config.ts         # Hardhaté…ç½®
â””â”€â”€ README.md                 # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1ï¸âƒ£ é€»è¾‘åˆçº¦ (SimpleCounter.sol)
```solidity
contract SimpleCounter {
    uint256 public count;    // ğŸ“¦ æ§½ä½0ï¼šè®¡æ•°å™¨å€¼
    address public owner;    // ğŸ“¦ æ§½ä½1ï¼šåˆçº¦æ‰€æœ‰è€…
    
    function increment() public { count += 1; }
    function incrementBy(uint256 value) public { count += value; }
    function reset() public { require(msg.sender == owner); count = 0; }
}
```

### 2ï¸âƒ£ ä»£ç†åˆçº¦ (SimpleProxy.sol)
```solidity
contract SimpleProxy {
    uint256 public count;           // ğŸ“¦ æ§½ä½0ï¼šä¸é€»è¾‘åˆçº¦åŒ¹é…
    address public owner;           // ğŸ“¦ æ§½ä½1ï¼šä¸é€»è¾‘åˆçº¦åŒ¹é…  
    address public implementation;  // ğŸ“¦ æ§½ä½2ï¼šé€»è¾‘åˆçº¦åœ°å€
    
    // æ ¸å¿ƒ delegatecall é€»è¾‘
    fallback() external payable {
        address impl = implementation;
        assembly {
            calldatacopy(0, 0, calldatasize())
            let result := delegatecall(gas(), impl, 0, calldatasize(), 0, 0)
            returndatacopy(0, 0, returndatasize())
            switch result
            case 0 { revert(0, returndatasize()) }
            default { return(0, returndatasize()) }
        }
    }
}
```

## ğŸ§ª æ ¸å¿ƒéªŒè¯æµ‹è¯•

### ğŸ” å…³é”®æµ‹è¯•æ¡ˆä¾‹

1. **çŠ¶æ€å­˜å‚¨éªŒè¯**ï¼šç¡®è®¤çŠ¶æ€å­˜å‚¨åœ¨ä»£ç†åˆçº¦è€Œéé€»è¾‘åˆçº¦
2. **delegatecall åŠŸèƒ½**ï¼šéªŒè¯é€šè¿‡ä»£ç†æˆåŠŸè°ƒç”¨é€»è¾‘å‡½æ•°
3. **åˆçº¦å‡çº§**ï¼šæµ‹è¯•é€»è¾‘åˆçº¦å‡çº§åçŠ¶æ€ä¿æŒ
4. **æƒé™æ§åˆ¶**ï¼šç¡®ä¿åªæœ‰ownerå¯ä»¥å‡çº§åˆçº¦
5. **é”™è¯¯å¤„ç†**ï¼šéªŒè¯å‚æ•°éªŒè¯å’Œå¼‚å¸¸æƒ…å†µ

### ğŸ“Š æµ‹è¯•ç»“æœåˆ†æ
```javascript
// ğŸ¯ å…³é”®éªŒè¯ï¼šçŠ¶æ€å­˜å‚¨ä½ç½®
const logicCount = await logicContract.count();     // åº”è¯¥æ˜¯ 0
const proxyCount = await proxyContract.count();     // åº”è¯¥æ˜¯ä¿®æ”¹åçš„å€¼
// âœ… è¯æ˜ï¼šçŠ¶æ€ç¡®å®å­˜å‚¨åœ¨ä»£ç†åˆçº¦ä¸­ï¼
```

## ğŸ® æ¸¸æˆå¼€å‘ç±»æ¯”ç†è§£

| æ¦‚å¿µ | æ¸¸æˆå¼€å‘ | ä»£ç†åˆçº¦ |
|------|----------|----------|
| **å®¢æˆ·ç«¯** | æ¸¸æˆå®‰è£…åŒ…ï¼ˆåœ°å€å›ºå®šï¼‰ | ä»£ç†åˆçº¦ï¼ˆåœ°å€ä¸å˜ï¼‰ |
| **é€»è¾‘åŒ…** | æ¸¸æˆæ›´æ–°åŒ…ï¼ˆå¯æ›¿æ¢ï¼‰ | é€»è¾‘åˆçº¦ï¼ˆå¯å‡çº§ï¼‰ |  
| **ç©å®¶æ•°æ®** | å­˜æ¡£æ–‡ä»¶ï¼ˆæŒä¹…ä¿å­˜ï¼‰ | ä»£ç†åˆçº¦çŠ¶æ€ï¼ˆæŒä¹…å­˜å‚¨ï¼‰ |
| **çƒ­æ›´æ–°** | æ— éœ€é‡è£…æ¸¸æˆ | æ— éœ€æ›´æ¢ä»£ç†åœ°å€ |

## ğŸš€ éƒ¨ç½²å’Œä½¿ç”¨

### ç¯å¢ƒè¦æ±‚
- Node.js 18+
- npm æˆ– yarn
- Hardhat å¼€å‘ç¯å¢ƒ

### å®‰è£…ä¾èµ–
```bash
cd lesson-4/1921
npm install
```

### ç¼–è¯‘åˆçº¦
```bash
npx hardhat compile
```

### è¿è¡Œæµ‹è¯•
```bash
npx hardhat test test/simple-test.js
```

### éƒ¨ç½²åˆçº¦
```bash
npx hardhat run scripts/simple-deploy.cjs
```

## ğŸ’¡ æ ¸å¿ƒå­¦ä¹ æ”¶è·

### ğŸ”‘ DelegateCall å…³é”®ç†è§£

1. **æ‰§è¡Œä¸Šä¸‹æ–‡**ï¼šdelegatecall åœ¨è°ƒç”¨è€…çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œç›®æ ‡ä»£ç 
2. **å­˜å‚¨æ§½ä½**ï¼šçŠ¶æ€å˜é‡æŒ‰æ§½ä½å·åŒ¹é…ï¼Œä¸æ˜¯æŒ‰å˜é‡å  
3. **msg.senderä¿æŒ**ï¼šåŸå§‹è°ƒç”¨è€…èº«ä»½åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¿æŒä¸å˜
4. **åˆçº¦å‡çº§**ï¼šå¯ä»¥æ›´æ¢é€»è¾‘åˆçº¦è€Œä¸ä¸¢å¤±çŠ¶æ€æ•°æ®

### ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘

- âœ… å­˜å‚¨å¸ƒå±€å¿…é¡»å…¼å®¹ï¼ˆæ§½ä½åŒ¹é…ï¼‰
- âœ… åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥å‡çº§åˆçº¦
- âœ… æ–°é€»è¾‘åˆçº¦éœ€è¦ç»è¿‡å……åˆ†æµ‹è¯•
- âœ… å‡çº§æ“ä½œéœ€è¦è°¨æ…å¤„ç†

### ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

- **DeFiåè®®å‡çº§**ï¼šåœ¨ä¸å½±å“ç”¨æˆ·èµ„äº§çš„æƒ…å†µä¸‹å‡çº§åè®®é€»è¾‘
- **DAOæ²»ç†**ï¼šé€šè¿‡æŠ•ç¥¨å†³å®šåˆçº¦åŠŸèƒ½å‡çº§
- **Bugä¿®å¤**ï¼šå¿«é€Ÿä¿®å¤åˆçº¦æ¼æ´è€Œä¸è¿ç§»çŠ¶æ€  
- **åŠŸèƒ½æ‰©å±•**ï¼šåœ¨ç°æœ‰åˆçº¦åŸºç¡€ä¸Šæ·»åŠ æ–°åŠŸèƒ½

## ğŸ“š æ·±å…¥å­¦ä¹ èµ„æº

- [EIP-1967: Proxy Storage Slots](https://eips.ethereum.org/EIPS/eip-1967)
- [OpenZeppelin Upgrades](https://docs.openzeppelin.com/upgrades/2.8/)
- [Proxy Patterns](https://blog.openzeppelin.com/proxy-patterns/)

## âœ… ä½œä¸šå®Œæˆæƒ…å†µ

### åŸºæœ¬è¦æ±‚ âœ…
- [x] åˆ›å»ºé€»è¾‘åˆçº¦ï¼ŒåŒ…å«ç®€å•çš„å¢åŠ å‡½æ•°
- [x] åˆ›å»ºä»£ç†åˆçº¦ï¼Œä½¿ç”¨ delegatecall è°ƒç”¨é€»è¾‘åˆçº¦
- [x] ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯çŠ¶æ€æ­£ç¡®æ›´æ–°
- [x] ç¡®ä¿è°ƒç”¨è€…çš„çŠ¶æ€è¢«ä¿ç•™

### æ‰©å±•åŠŸèƒ½ âœ…  
- [x] å®ç°åˆçº¦å‡çº§åŠŸèƒ½
- [x] æ·»åŠ æƒé™æ§åˆ¶æœºåˆ¶
- [x] å®Œå–„é”™è¯¯å¤„ç†é€»è¾‘
- [x] è¯¦ç»†çš„å­¦ä¹ æ–‡æ¡£å’Œä»£ç æ³¨é‡Š

---

**ğŸ† é¡¹ç›®çŠ¶æ€**: âœ… å·²å®Œæˆ  
**ğŸ“ æœ€åæ›´æ–°**: 2025å¹´11æœˆ20æ—¥  
**ğŸ“ å­¦ä¹ æˆæœ**: æ·±å…¥ç†è§£äº† delegatecall æœºåˆ¶åŠå…¶åœ¨åˆçº¦å‡çº§ä¸­çš„åº”ç”¨
