# Uniswap V2 Polkadot 测试结果分析

## 测试环境配置

- **区块链节点**: substrate-node (端口 9944 WebSocket)
- **ETH RPC 适配器**: eth-rpc (端口 8545)
- **测试命令**: `POLKA_NODE=true REVM=true npx hardhat test`
- **网络模式**: Polkadot 节点上的 EVM 兼容性模式

## 测试结果概览

**测试总数**: 23 个
**通过测试**: 19 个 (82.6%)
**失败测试**: 4 个 (17.4%)

## 通过的测试

### UniswapV2Factory
- ✅ feeTo, feeToSetter, allPairsLength
- ✅ createPair
- ✅ createPair:reverse

### UniswapV2Pair
- ✅ mint
- ✅ getInputPrice:0 - getInputPrice:6 (7个测试)
- ✅ optimistic:0 - optimistic:3 (4个测试)
- ✅ swap:token0
- ✅ swap:token1
- ✅ burn
- ✅ feeTo:off

## 失败的测试

### 1. UniswapV2ERC20 - "before each" hook
```
TypeError: Cannot read properties of undefined (reading 'getAddress')
  at Context.<anonymous> (test/UniswapV2ERC20.js:41:36)
```

### 2. UniswapV2Factory - setFeeTo
```
TypeError: Cannot read properties of undefined (reading 'getAddress')
  at Context.<anonymous> (test/UniswapV2Factory.js:110:36)
```

### 3. UniswapV2Factory - setFeeToSetter
```
TypeError: Cannot read properties of undefined (reading 'getAddress')
  at Context.<anonymous> (test/UniswapV2Factory.js:119:36)
```

### 4. UniswapV2Pair - feeTo:on
```
TypeError: Cannot read properties of undefined (reading 'address')
  at Context.<anonymous> (test/UniswapV2Pair.js:293:34)
```

## 失败原因分析

### 1. 共同问题: 合约地址获取失败

所有失败的测试都与同一个问题相关: **无法获取合约地址**。具体来说，测试代码尝试访问 `contract.getAddress()` 或 `contract.address`，但这些属性是 `undefined`。

### 2. 可能的原因

1. **测试环境不兼容**: 
   - REVM 模式下的合约部署和实例化方式可能与原生 EVM 不同
   - 测试代码假设的合约实例结构可能不适用于 Polkavm 环境

2. **合约部署时序问题**: 
   - 某些测试中的合约可能尚未完全部署或初始化就尝试访问其地址

3. **Hardhat 插件兼容性**: 
   - hardhat-polkadot-node 插件可能在 REVM 模式下处理合约地址的方式与标准 Hardhat 不同

4. **测试框架问题**: 
   - 测试代码中使用的 fixture 设置或共享工具函数可能需要针对 Polkavm 环境进行调整

## 解决方案建议

1. **修改测试代码**: 
   - 检查并更新测试文件中的合约实例访问方式
   - 确保在访问合约地址前等待合约完全部署

2. **调整 Hardhat 配置**: 
   - 可能需要为 REVM 模式添加特定的网络配置
   - 确保使用正确的提供者和账户设置

3. **合约实例调整**: 
   - 在测试中添加额外的检查和错误处理
   - 可能需要重写 fixture 函数以适应 Polkavm 环境

## 后续步骤

1. 检查 `test/shared/fixtures.js` 中的合约部署逻辑
2. 修改 `test/UniswapV2ERC20.js`、`test/UniswapV2Factory.js` 和 `test/UniswapV2Pair.js` 中的地址获取方式
3. 为 Polkavm 环境创建专用的测试适配器或包装函数